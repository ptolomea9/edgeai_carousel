"// Build json2video API payload for merging video clips with text overlays\n// Round 6.2: Fixed to pass through videoClips and other data for email\nconst data = $input.first().json;\n\nif (!data.videoClips || data.videoClips.length === 0) {\n  return [{\n    json: {\n      error: 'No video clips to merge',\n      payload: null,\n      // Still pass through for downstream\n      generationId: data.generationId,\n      recipientEmail: data.recipientEmail,\n      videoClips: [],\n      totalClips: 0,\n      successCount: 0,\n      allSuccess: false\n    }\n  }];\n}\n\n// Text sanitization function to fix common formatting issues\nfunction sanitizeText(text) {\n  if (!text) return '';\n  return text\n    .replace(/:\\s*-\\s*/g, ': ')      // Remove \": -\" patterns\n    .replace(/^\\s*-\\s*/g, '')         // Remove leading dashes\n    .replace(/!{2,}/g, '!')           // Clean up multiple exclamation marks\n    .replace(/[!?.:,]+$/g, match => match[0])  // Remove trailing punctuation combos\n    .replace(/\\s{2,}/g, ' ')          // Clean up double spaces\n    .trim();\n}\n\n// Format body text as HTML for proper bullet/paragraph rendering\nfunction formatBodyTextAsHtml(text, style) {\n  if (!text) return null;\n\n  // Detect if text has bullet points (lines starting with -)\n  const lines = text.split('\\n');\n  const hasBullets = lines.some(line => line.trim().startsWith('-'));\n\n  if (hasBullets) {\n    // Format as HTML list\n    let html = '';\n    let inList = false;\n\n    for (const line of lines) {\n      const trimmed = line.trim();\n      if (trimmed.startsWith('-')) {\n        if (!inList) {\n          html += '<ul style=\"list-style-type: disc; padding-left: 20px; margin: 10px 0; text-align: left;\">';\n          inList = true;\n        }\n        html += `<li style=\"margin: 8px 0;\">${trimmed.substring(1).trim()}</li>`;\n      } else if (trimmed) {\n        if (inList) {\n          html += '</ul>';\n          inList = false;\n        }\n        html += `<p style=\"margin: 8px 0;\">${trimmed}</p>`;\n      }\n    }\n    if (inList) html += '</ul>';\n\n    return html;\n  } else {\n    // Format as paragraphs with line breaks\n    return text.split('\\n').filter(l => l.trim()).map(l =>\n      `<p style=\"margin: 8px 0;\">${l.trim()}</p>`\n    ).join('');\n  }\n}\n\n// Art style to text styling mapping\n// ALL background opacities at 0.4\nconst artStyleTextMap = {\n  'synthwave': {\n    headlineFont: 'Orbitron',\n    headlineColor: '#ff00ff',\n    headlineSize: 72,\n    headlineShadow: '0 0 10px #ff00ff, 0 0 20px #ff00ff, 0 0 40px #ff00ff',\n    bodyFont: 'Orbitron',\n    bodyColor: '#ff00ff',\n    bodySize: 64,\n    bodyShadow: '0 0 8px #ff00ff, 0 0 16px #ff00ff',\n    bgColor: 'rgba(0,0,0,0.4)'\n  },\n  'anime': {\n    headlineFont: 'Bangers',\n    headlineColor: '#ff6b6b',\n    headlineSize: 68,\n    headlineShadow: '3px 3px 0 #000000, -1px -1px 0 #ffffff',\n    bodyFont: 'Bangers',\n    bodyColor: '#ff6b6b',\n    bodySize: 60,\n    bodyShadow: '2px 2px 0 #000000',\n    bgColor: 'rgba(0,0,0,0.4)'\n  },\n  '3d-pixar': {\n    headlineFont: 'Fredoka One',\n    headlineColor: '#ffd93d',\n    headlineSize: 64,\n    headlineShadow: '3px 3px 6px rgba(0,0,0,0.4)',\n    bodyFont: 'Fredoka One',\n    bodyColor: '#ffd93d',\n    bodySize: 56,\n    bodyShadow: '2px 2px 4px rgba(0,0,0,0.4)',\n    bgColor: 'rgba(0,0,0,0.4)'\n  },\n  'watercolor': {\n    headlineFont: 'Pacifico',\n    headlineColor: '#5c4033',\n    headlineSize: 60,\n    headlineShadow: '2px 2px 4px rgba(255,255,255,0.5)',\n    bodyFont: 'Pacifico',\n    bodyColor: '#5c4033',\n    bodySize: 54,\n    bodyShadow: '1px 1px 3px rgba(255,255,255,0.5)',\n    bgColor: 'rgba(255,255,255,0.4)'\n  },\n  'minimalist': {\n    headlineFont: 'Montserrat',\n    headlineColor: '#1a1a1a',\n    headlineSize: 56,\n    headlineShadow: 'none',\n    bodyFont: 'Montserrat',\n    bodyColor: '#1a1a1a',\n    bodySize: 48,\n    bodyShadow: 'none',\n    bgColor: 'rgba(255,255,255,0.5)'\n  },\n  'comic': {\n    headlineFont: 'Bangers',\n    headlineColor: '#ffff00',\n    headlineSize: 72,\n    headlineShadow: '4px 4px 0 #000000, -2px -2px 0 #000000',\n    bodyFont: 'Bangers',\n    bodyColor: '#ffff00',\n    bodySize: 64,\n    bodyShadow: '2px 2px 0 #000000',\n    bgColor: 'rgba(0,0,0,0.4)'\n  },\n  'photorealistic': {\n    headlineFont: 'Playfair Display',\n    headlineColor: '#ffffff',\n    headlineSize: 54,\n    headlineShadow: '2px 2px 8px rgba(0,0,0,0.6)',\n    bodyFont: 'Playfair Display',\n    bodyColor: '#ffffff',\n    bodySize: 48,\n    bodyShadow: '1px 1px 4px rgba(0,0,0,0.5)',\n    bgColor: 'rgba(0,0,0,0.4)'\n  },\n  'custom': {\n    headlineFont: 'Roboto',\n    headlineColor: '#ffffff',\n    headlineSize: 60,\n    headlineShadow: '2px 2px 6px rgba(0,0,0,0.5)',\n    bodyFont: 'Roboto',\n    bodyColor: '#ffffff',\n    bodySize: 54,\n    bodyShadow: '1px 1px 4px rgba(0,0,0,0.4)',\n    bgColor: 'rgba(0,0,0,0.4)'\n  }\n};\n\nconst artStyle = data.artStyle || 'synthwave';\nconst style = artStyleTextMap[artStyle] || artStyleTextMap['synthwave'];\nconst videoDuration = 5;\n\nconst scenes = [];\n\nfor (const clip of data.videoClips) {\n  const elements = [];\n\n  // Video background\n  elements.push({\n    type: 'video',\n    src: clip.videoUrl,\n    duration: videoDuration\n  });\n\n  // HEADLINE - read from clip.headline, centered at top with full-width wrapper\n  const cleanHeadline = sanitizeText(clip.headline);\n  if (cleanHeadline) {\n    let textShadowCss = '';\n    if (style.headlineShadow && style.headlineShadow !== 'none') {\n      textShadowCss = `text-shadow: ${style.headlineShadow};`;\n    }\n\n    elements.push({\n      type: 'html',\n      html: `<div style=\"width: 1080px; display: flex; justify-content: center; padding-top: 120px;\">\n        <div style=\"\n          font-family: ${style.headlineFont}, sans-serif;\n          font-size: ${style.headlineSize}px;\n          color: ${style.headlineColor};\n          font-weight: bold;\n          background-color: ${style.bgColor};\n          ${textShadowCss}\n          text-align: center;\n          padding: 10px 20px;\n          border-radius: 8px;\n          max-width: 90%;\n        \">${cleanHeadline}</div>\n      </div>`,\n      duration: videoDuration,\n      position: 'top-left'\n    });\n  }\n\n  // BODY - read from clip.bodyText, centered at y:800\n  const bodyHtml = formatBodyTextAsHtml(clip.bodyText, style);\n  if (bodyHtml) {\n    let textShadowCss = '';\n    if (style.bodyShadow && style.bodyShadow !== 'none') {\n      textShadowCss = `text-shadow: ${style.bodyShadow};`;\n    }\n\n    elements.push({\n      type: 'html',\n      html: `<div style=\"width: 1080px; display: flex; justify-content: center;\">\n        <div style=\"\n          font-family: ${style.bodyFont}, sans-serif;\n          font-size: ${style.bodySize}px;\n          color: ${style.bodyColor};\n          font-weight: normal;\n          background-color: ${style.bgColor};\n          ${textShadowCss}\n          text-align: center;\n          padding: 10px 20px;\n          border-radius: 8px;\n          max-width: 85%;\n        \">${bodyHtml}</div>\n      </div>`,\n      duration: videoDuration,\n      position: 'custom',\n      x: 0,\n      y: 800\n    });\n  }\n\n  // BRANDING - bottom-right corner watermark\n  if (data.branding && data.branding.text) {\n    let textShadowCss = '';\n    if (style.headlineShadow && style.headlineShadow !== 'none') {\n      textShadowCss = `text-shadow: ${style.headlineShadow};`;\n    }\n    \n    // Size is 70% of headline size\n    const brandingSize = Math.round(style.headlineSize * 0.7);\n\n    elements.push({\n      type: 'html',\n      html: `<div style=\"width: 1080px; display: flex; justify-content: flex-end; padding-right: 30px;\">\n        <div style=\"\n          font-family: ${style.headlineFont}, sans-serif;\n          font-size: ${brandingSize}px;\n          color: ${style.headlineColor};\n          font-weight: bold;\n          background-color: ${style.bgColor};\n          ${textShadowCss}\n          text-align: center;\n          padding: 8px 16px;\n          border-radius: 6px;\n          opacity: 0.85;\n        \">${data.branding.text}</div>\n      </div>`,\n      duration: videoDuration,\n      position: 'custom',\n      x: 0,\n      y: 1800\n    });\n  }\n\n  scenes.push({\n    elements,\n    transition: {\n      style: 'fade',\n      duration: 0.5\n    }\n  });\n}\n\nconst payload = {\n  resolution: 'instagram-story',\n  scenes\n};\n\n// CRITICAL: Pass through videoClips and other data for downstream nodes (email)\nreturn [{\n  json: {\n    generationId: data.generationId,\n    artStyle: data.artStyle,\n    recipientEmail: data.recipientEmail,\n    branding: data.branding,\n    videoClips: data.videoClips,  // REQUIRED for email\n    totalClips: data.totalClips,\n    successCount: data.successCount,\n    allSuccess: data.allSuccess,\n    originalSlides: data.originalSlides,\n    payload,\n    payloadJson: JSON.stringify(payload)\n  }\n}];"
